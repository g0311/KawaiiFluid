// Copyright 2026 Team_Bruteforce. All Rights Reserved.
// GPU Bone Delta Attachment - Boundary Particle following system
//
// This header provides structures and constants for per-particle boundary attachment data.
// Particles attach to WorldBoundaryParticles using OriginalIndex (stable across Z-Order sorting).
//
// Used by ApplyBoneTransform (simulation start) and UpdateBoneDeltaAttachment (simulation end)

#pragma once

#include "/Engine/Public/Platform.ush"

//=============================================================================
// FGPUBoneDeltaAttachment Structure (must match C++ in GPUBoundaryAttachment.h)
// 48 bytes, 16-byte aligned
//=============================================================================

struct FGPUBoneDeltaAttachment
{
	int BoundaryParticleIndex;  // 4 bytes - Index into WorldBoundaryParticles (-1 = not attached)
	float Padding1;             // 4 bytes - Alignment padding (total: 8)

	float3 LocalNormal;         // 12 bytes - Surface normal in world space (for anisotropy)
	float Padding2;             // 4 bytes - Alignment padding (total: 24)

	float3 PreviousPosition;    // 12 bytes - Previous frame position (for detach check)
	float Padding3;             // 4 bytes - Alignment padding (total: 40)

	float3 LocalOffset;         // 12 bytes - Offset from boundary position (physics drift)
	float Padding4;             // 4 bytes - Alignment padding (total: 56)

	// Additional padding to reach 64 bytes (16-byte aligned)
	float Padding5;             // 4 bytes
	float Padding6;             // 4 bytes (total: 64)
};

//=============================================================================
// Constants
//=============================================================================

// Detach distance threshold in cm
// If particle moves more than this distance from previous position, it detaches
#define BONE_DELTA_DETACH_DISTANCE 100000.0f  // 100000cm = 1km (For testing: almost never detaches)

// Invalid boundary particle index (not attached)
#define BONE_DELTA_INVALID_INDEX -1

//=============================================================================
// Helper Functions
//=============================================================================

/**
 * Check if attachment is valid (attached to a boundary particle)
 */
bool IsBoneDeltaAttached(FGPUBoneDeltaAttachment attachment)
{
	return attachment.BoundaryParticleIndex >= 0;
}

/**
 * Clear attachment data
 */
void ClearBoneDeltaAttachment(inout FGPUBoneDeltaAttachment attachment)
{
	attachment.BoundaryParticleIndex = BONE_DELTA_INVALID_INDEX;
	attachment.LocalNormal = float3(0, 0, 0);
	attachment.LocalOffset = float3(0, 0, 0);
	// Note: PreviousPosition is kept for reference
}

/**
 * Check if particle should detach based on distance from previous position
 * @param currentPos - Current world position
 * @param attachment - Attachment data containing previous position
 * @return true if should detach
 */
bool ShouldDetachByDistance(float3 currentPos, FGPUBoneDeltaAttachment attachment)
{
	float dist = length(currentPos - attachment.PreviousPosition);
	return dist > BONE_DELTA_DETACH_DISTANCE;
}

